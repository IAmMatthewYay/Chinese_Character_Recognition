<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Chinese Character Recognition</title>
<style>
body {
    background-color: #7b5e3b;  /* brown background */
    color: #f5deb3;
    font-family: 'Papyrus', 'Segoe UI', sans-serif;
    text-align: center;
    padding: 20px;
}

h1 {
    margin-bottom: 25px;
    color: #fdf5e6;
}

.container {
    max-width: 900px;
    margin: auto;
    background-color: #d2b48c;
    padding: 30px;
    border-radius: 15px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
}

.logos {
    display: flex;
    flex-wrap: wrap;
    justify-content: center;
    gap: 20px;
    margin-bottom: 30px;
}

.logo {
    max-width: 120px;
    max-height: 120px;
    border-radius: 12px;
    border: 2px solid #c49a6c;
    padding: 5px;
    background-color: #f5deb3;
}

.upload-section {
    margin-bottom: 30px;
}

input[type="file"], select {
    padding: 8px;
    border-radius: 6px;
    border: 1px solid #c49a6c;
    background-color: #f5deb3;
}

button {
    background-color: #a67b5b;
    border: none;
    padding: 12px 25px;
    color: white;
    font-size: 16px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 10px;
    transition: background-color 0.3s;
}

button:hover { background-color: #8b5a2b; }

video, .preview {
    border: 3px solid #c49a6c;
    border-radius: 12px;
    margin-top: 10px;
}

video {
    width: 320px;
    height: 240px;
}

img.preview {
    width: 256px;
    height: 256px;
    object-fit: contain;
    display: block;
    margin: 15px auto 10px auto;
}

.result {
    font-size: 1.2em;
    margin-top: 10px;
    color: #5c4033;
}

.camera-container {
    margin-bottom: 30px;
}

#mobileControls button, #desktopFlipBtn {
    margin: 5px;
}
</style>
</head>
<body>
<div class="container">
    <h1>Chinese Character Recognition</h1>

    <div class="logos">
        {% for logo in logos %}
            <img src="{{ url_for('static', filename='logos/' + logo.path) }}" class="logo" alt="{{ logo.alt }}">
        {% endfor %}
    </div>

    <!-- File Upload Section -->
    <div class="upload-section">
        <form method="POST" enctype="multipart/form-data">
            <label for="model_select"><b>Select Model:</b></label>
            <select name="model_select" id="model_select">
                <option value="alexnet" {% if current_model == 'alexnet' %}selected{% endif %}>Weights_Alex_Net.h5</option>
                <option value="alexnet_old" {% if current_model == "alexnet_old" %}selected{% endif %}>Weights_Alex_Net_Old.h5</option>
                <option value="alexnet_old2" {% if current_model == "alexnet_old2" %}selected{% endif %}>Weights_Alex_Net_Old_2.h5</option>
                <option value="resnet101" {% if current_model == 'resnet101' %}selected{% endif %}>Weights_Resnet_101.h5</option>
                <option value="resnet101_old" {% if current_model == 'resnet101_old' %}selected{% endif %}>Weights_Resnet_101_Old.h5</option>
                <option value="resnet18" {% if current_model == 'resnet18' %}selected{% endif %}>Weights_ResNet_18.h5</option>
                <option value="resnet18_old" {% if current_model == 'resnet18_old' %}selected{% endif %}>Weights_Resnet_18_Old.h5</option>
                <option value="resnet18_old2" {% if current_model == 'resnet18_old2' %}selected{% endif %}>Weights_Resnet_18_Old_2.h5</option>
                <option value="resnet18_old3" {% if current_model == 'resnet18_old3' %}selected{% endif %}>Weights_Resnet_18_Old_3.h5</option>
            </select>
            <br><br>

            <input type="file" name="file" accept="image/*" capture="environment" required>
            <br>
            <button type="submit">Upload & Detect</button>
        </form>

        {% if uploaded_img %}
            <img src="{{ uploaded_img }}" class="preview" alt="Uploaded Image">
            <div class="result">
                <p>Prediction: {{ result }}</p>
                <p>Confidence: {{ confidence }}</p>
            </div>
        {% endif %}
    </div>

    <!-- Camera Section -->
    <div class="camera-container">
        <h3>Live Camera Preview:</h3>

        <div id="mobileControls" style="display:none;">
            <button id="switchCamera">Change Camera</button>
            <button onclick="flipCamera()">Flip Image</button>
        </div>

        <select id="cameraSelect" style="display:none;"></select>
        <button onclick="flipCamera()" id="desktopFlipBtn" style="display:none;">Flip Image</button>

        <br>
        <video id="camera" autoplay playsinline></video>
        <img id="camera_preview" class="preview" style="display:none;">
        <br>
        <button onclick="snapAndPredict()">Take Snapshot & Detect</button>
        <div id="camera_result" class="result"></div>
    </div>
</div>

<script>
let video = document.getElementById('camera');
let preview = document.getElementById('camera_preview');
let cameraResult = document.getElementById('camera_result');
let cameraSelect = document.getElementById('cameraSelect');
let mobileControls = document.getElementById('mobileControls');
let switchCameraBtn = document.getElementById('switchCamera');
let desktopFlipBtn = document.getElementById('desktopFlipBtn');
let flipped = false;
let currentStream = null;
let useFrontCamera = true;

const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

function startCamera(deviceId=null){
    if(currentStream) currentStream.getTracks().forEach(t=>t.stop());
    let constraints;
    if(isMobile){
        constraints = { video: { facingMode: useFrontCamera ? "user" : "environment" } };
    } else {
        constraints = deviceId ? { video: { deviceId: { exact: deviceId } } } : { video: true };
    }

    navigator.mediaDevices.getUserMedia(constraints)
        .then(stream => {
            currentStream = stream;
            video.srcObject = stream;
            video.style.transform = flipped ? "scaleX(-1)" : "scaleX(1)";
        })
        .catch(err => console.log("Camera error:", err));
}

function flipCamera(){
    flipped = !flipped;
    video.style.transform = flipped ? "scaleX(-1)" : "scaleX(1)";
}

function snapAndPredict(){
    const canvas = document.createElement('canvas');
    canvas.width=128; canvas.height=128;
    const ctx=canvas.getContext('2d');
    if(flipped){ ctx.translate(128,0); ctx.scale(-1,1); }
    ctx.drawImage(video,0,0,128,128);
    const dataURL = canvas.toDataURL('image/png');

    preview.src = dataURL; 
    preview.style.display='block';

    fetch('/predict_camera',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({image:dataURL})
    }).then(res=>res.json()).then(data=>{
        cameraResult.innerHTML = `<p>Prediction: ${data.result}</p><p>Confidence: ${data.confidence}%</p>`;
    });
}

if(isMobile){
    mobileControls.style.display='block';
    switchCameraBtn.onclick = ()=>{
        useFrontCamera = !useFrontCamera;
        startCamera();
    };
    startCamera();
} else {
        cameraSelect.style.display='inline-block';
    desktopFlipBtn.style.display='inline-block';

    // Request camera permission first
    navigator.mediaDevices.getUserMedia({ video: true })
    .then(stream => {
        // Stop previous stream if any
        if(currentStream) currentStream.getTracks().forEach(t => t.stop());
        currentStream = stream;
        video.srcObject = stream;

        // Enumerate devices after permission granted
        navigator.mediaDevices.enumerateDevices().then(devices => {
            cameraSelect.innerHTML = "";
            const videoDevices = devices.filter(d => d.kind === "videoinput");

            videoDevices.forEach((device, index) => {
                const option = document.createElement('option');
                option.value = device.deviceId;
                // Use device.label if available
                option.text = device.label || `Camera ${index+1}`;
                cameraSelect.appendChild(option);
            });

            if(cameraSelect.options.length > 0) startCamera(cameraSelect.value);
        });
    })
    .catch(err => console.error("Camera permission error:", err));

    cameraSelect.onchange = () => startCamera(cameraSelect.value);
}
</script>
</body>
</html>